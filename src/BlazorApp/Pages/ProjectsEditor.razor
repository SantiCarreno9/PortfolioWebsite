@page "/projectseditor"

<Header />
<div>
    <div class="m-5">
        <h3>Project Editor</h3>
        <InputFile OnChange="LoadJsonFile" accept=".json" />        

        <button @onclick="DownloadJson">Download Edited Projects</button>

        @if (_projects != null)
        {
            <p>Loaded Projects: @(_projects.Count)</p>
            <DisplayProjects Projects="_projects" OnProjectSelected="SelectProject"></DisplayProjects>
        }        

        <EditForm Model="@project" OnSubmit="SaveChanges">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div>
                <label for="title">Title:</label>
                <InputText id="title" @bind-Value="project.Title" class="form-control" />
            </div>

            <div>
                <label for="description">Description:</label>
                <InputTextArea id="description" @bind-Value="project.Description" class="form-control" />
            </div>

            <div>
                <label for="category">Category:</label>
                <InputSelect id="category" @bind-Value="project.Category" class="form-control">
                    @foreach (var category in Enum.GetValues<ProjectCategory>())
                    {
                        <option value="@category">@category</option>
                    }
                </InputSelect>
            </div>

            <div>
                <h4>Keywords</h4>
                <button @onclick="()=>{project.Keywords.Add(string.Empty);}" @onclick:preventDefault>+</button>
                @for (int i = 0; i < project.Keywords.Count; i++)
                {
                    <div>
                        <InputText class="form-control" @bind-Value="project.Keywords[i]" />
                    </div>
                }
                @* <InputText id="url" @bind-Value="project.Url" class="form-control" /> *@
            </div>
            @* <div>
        <label for="keywords">Keywords:</label>
        <InputText id="keywords" @bind-Value="project.Keywords" class="form-control" />
    </div>
    *@
            <div>
                <label for="mediaContent">Media Content:</label>
                <InputFile OnChange="HandleFileSelected" />
            </div>

            <button type="submit" class="btn btn-primary">Save</button>
        </EditForm>
    </div>
    <ProjectCard Project="project"></ProjectCard>
</div>

<script>
    window.downloadFileFromStream = async (fileName, contentStreamReference) => {
        const arrayBuffer = await contentStreamReference.arrayBuffer();
        const blob = new Blob([arrayBuffer]);
        const url = URL.createObjectURL(blob);

        const handle = await window.showSaveFilePicker({
            suggestedName: fileName,
            types: [{
                description: 'JSON Files',
                accept: { 'application/json': ['.json'] }
            }]
        });

        const writable = await handle.createWritable();
        await writable.write(blob);
        await writable.close();

        URL.revokeObjectURL(url);
    };
</script>

@code {
    private Project project = new Project();

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {

        // Handle file upload logic here
    }
}